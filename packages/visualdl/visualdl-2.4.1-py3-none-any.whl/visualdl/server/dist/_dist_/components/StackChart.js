import*as st from"../utils/chart.js";import k,{useCallback as h,useEffect as D,useImperativeHandle as gt,useMemo as S,useRef as X,useState as W}from"../../__snowpack__/pkg/react.js";import{primaryColor as xt,transitionProps as yt}from"../utils/style.js";import vt,{Wrapper as kt,useChartTheme as _t}from"../hooks/useECharts.js";import bt from"../../__snowpack__/pkg/react-spinners/GridLoader.js";import Pt from"../../__snowpack__/pkg/lodash/defaultsDeep.js";import Ot from"../../__snowpack__/pkg/styled-components.js";import Tt from"../hooks/useThrottleFn.js";const jt=Ot.div`
    position: absolute;
    z-index: 1;
    background-color: var(--tooltip-background-color);
    color: var(--tooltip-text-color);
    border-radius: 4px;
    padding: 5px;
    display: none;
    ${yt(["color","background-color"])}
`,zt=k.forwardRef(({options:_,data:Y,title:b,loading:nt,zoom:it,className:lt,onInit:E},at)=>{var et;const{minZ:I,maxZ:H,minY:c,maxY:d,minX:G,maxX:q,...B}=Y!=null?Y:{minZ:0,maxZ:0,minY:0,maxY:0,minX:0,maxX:0,data:null},g=S(()=>{var e;return(e=B.data)!=null?e:[]},[B.data]),x=S(()=>c===0&&d===0?-.4:c-(d-c)*.4,[c,d]),y=h((e,o,i,r)=>{const t=r([e,o]);return t?(t[1]-=(i-I)/(H-I)*(r([0,c])[1]-r([0,x])[1]),t):[0,0]},[I,H,c,x]),L=h((e,o,i)=>{const r=[];let t=0;for(;g[e]&&t<g[e].length;){const n=o(t++),p=o(t++),u=o(t++);u!==1&&t===3&&r.push(y(n,p,1,i)),r.push(y(n,p,u,i)),u!==1&&t===g[e].length&&r.push(y(n,p,1,i))}return r},[y,g]),J=h((e,o)=>{var r,t;const i=L(e.dataIndex,o.value,o.coord);return{type:"path",silent:!0,z:(r=o.value)==null?void 0:r.call(o,1),shape:{points:i},style:(t=o.style)==null?void 0:t.call(o,{stroke:st.xAxis.axisLine.lineStyle.color,lineWidth:1})}},[L]),[f,K]=W(null),[v,N]=W([]),m=X(null),[ct,Q]=W(""),U=X(f),pt=X(v);D(()=>{U.current=f},[f]),D(()=>{pt.current=v},[v]);const P=(et=(_==null?void 0:_.axisPointer).label)==null?void 0:et.formatter,V=h(e=>!P||U.current==null?"":typeof P=="string"?P:P(e),[P]),tt=_t(),a=S(()=>{const{color:e,colorAlt:o,toolbox:i,series:r,...t}=st;return Pt({title:{text:b!=null?b:""},visualMap:{min:c,max:d},axisPointer:{label:{formatter:V}},xAxis:{min:G,max:q,axisPointer:{type:"none"}},yAxis:{inverse:!0,position:"right",min:x,max:d,axisLine:{onZero:!1},axisLabel:{formatter:n=>n<c?"":n+""},axisPointer:{type:"none"}},grid:{left:t.grid.right,right:t.grid.left},tooltip:{trigger:"none",showContent:!1,axisPointer:{axis:"y",snap:!1}},series:[{...r,type:"custom",silent:!0,data:g,renderItem:J}]},_,tt,t)},[_,b,tt,g,G,q,c,d,x,J,V]),O=h(()=>{K(null),N([]),a.tooltip.formatter&&(Q(""),m.current&&(m.current.style.display="none"))},[a.tooltip]),mt=h((e,o)=>{var i,r,t;try{if(!e||!o)return;const{offsetX:n,offsetY:p}=o;if(p<x+((i=a.grid)==null?void 0:i.top)){O();return}const[u,$]=e.convertFromPixel("grid",[n,p]),Z=(r=(s==null?void 0:s.getOption().series).data)!=null?r:[],w=Z.map(l=>l[1]).sort((l,j)=>l-j);let C=0,T=null;for(;C<w.length;)if($<=w[C++]){T=w[C-1];break}const M=T==null?null:Z.findIndex(l=>l[1]===T);K(M);let F=[];T==null||(F=Z.map(l=>{const j=[l[0],l[1],l[2]];let ot=Number.POSITIVE_INFINITY;for(let z=0;z<l.length;z+=3){const rt=Math.abs(l[z]-u);rt<ot&&(ot=rt,j[0]=l[z],j[2]=l[z+2])}return j})),N(F);const R=a.tooltip;R.formatter&&(Q(M==null?"":(t=R.formatter)==null?void 0:t.call(R,F[M])),m.current&&(T==null?m.current.style.display="none":(m.current.style.left=`${n+10}px`,m.current.style.top=`${p+10}px`,m.current.style.display="block")))}catch{O()}},[O,x,a.grid,a.tooltip]),A=Tt(mt,{wait:200}),ut=h(e=>{try{const o=e.getZr();o&&(o.on("mousemove",i=>A.run(e,i)),o.on("mouseout",()=>{A.cancel(),O()}))}catch{A.cancel()}E==null||E(e)},[E,A,O]),{ref:ft,echart:s,wrapper:ht,saveAsImage:dt}=vt({loading:!!nt,zoom:it,autoFit:!0,onInit:ut});return gt(at,()=>({saveAsImage:()=>{dt(b)}})),D(()=>{s==null||s.setOption(a,{notMerge:!0})},[s,a]),D(()=>{var e;if(s)try{if(f==null)s.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"remove"}]}});else{const i=(e=s.getOption().series.data)!=null?e:[],r=n=>s.convertToPixel("grid",n),t=n=>i[f][n];s.setOption({graphic:{elements:[{id:"highlight",type:"polyline",$action:"replace",silent:!0,cursor:"default",zlevel:1,z:1,shape:{points:L(f,t,r)}}]}})}}catch{}},[f,s,L]),D(()=>{var e,o,i,r;if(s)try{if(!v.length)s.setOption({graphic:{elements:(r=(i=(o=(e=s.getOption())==null?void 0:e.graphic)==null?void 0:o[0])==null?void 0:i.elements)==null?void 0:r.filter(t=>t.id.startsWith("dot")).map(t=>({id:t.id,type:"circle",$action:"remove"}))}});else{const t=n=>s.convertToPixel("grid",n);s.setOption({graphic:{elements:v.map((n,p)=>{var $;const u=y(n[0],n[1],n[2],t);return{type:"circle",id:`dot${p}`,$action:"replace",cursor:"default",zlevel:1,z:2,shape:{cx:u[0],cy:u[1],r:3},style:{fill:"#fff",stroke:($=a.color)==null?void 0:$[0],lineWidth:2}}})}})}}catch{}},[v,s,a.color,y]),k.createElement(kt,{ref:ht,className:lt},!s&&k.createElement("div",{className:"loading"},k.createElement(bt,{color:xt,size:"10px"})),k.createElement("div",{className:"echarts",ref:ft}),k.createElement(jt,{className:"tooltip",ref:m,dangerouslySetInnerHTML:{__html:ct}}))});export default zt;
