"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_components_avatarChooser_tsx"],{"./app/components/avatarChooser.tsx":(e,t,a)=>{a.d(t,{Z:()=>O});var i=a("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),s=a("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=(a("../node_modules/core-js/modules/web.dom-collections.iterator.js"),a("../node_modules/react/index.js")),r=a("./app/actionCreators/indicator.tsx"),n=a("./app/components/avatar/index.tsx");a("../node_modules/core-js/modules/web.url.js"),a("../node_modules/core-js/modules/web.url-search-params.js");const l=(0,s.Z)("div",{target:"e1tfl33i0"})("border:1px solid ",(e=>e.theme.border),";box-shadow:none;background:",(e=>e.theme.backgroundSecondary),";padding:",(e=>e.hasImage?"80px 30px":"15px 20px"),";margin-bottom:20px;border-radius:3px;",(e=>e.centered&&"text-align: center"),";");var p=a("./app/constants/index.tsx"),d=a("./app/locale.tsx"),h=a("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");function c(e,t){return(e-2*e+(t-2*t))/2}function u(e,t){return(e-2*e+t)/2}function m(e,t){return(e+(t-2*t))/2}function g(e,t){return(e+t)/2}const v={nw:["top","left"],ne:["top","right"],se:["bottom","right"],sw:["bottom","left"]};class f extends o.Component{constructor(){super(...arguments),(0,i.Z)(this,"state",{file:null,objectURL:null,mousePosition:{pageX:0,pageY:0},resizeDimensions:{top:0,left:0,size:0},resizeDirection:null}),(0,i.Z)(this,"file",(0,o.createRef)()),(0,i.Z)(this,"canvas",(0,o.createRef)()),(0,i.Z)(this,"image",(0,o.createRef)()),(0,i.Z)(this,"cropContainer",(0,o.createRef)()),(0,i.Z)(this,"MIN_DIMENSION",256),(0,i.Z)(this,"MAX_DIMENSION",1024),(0,i.Z)(this,"ALLOWED_MIMETYPES","image/gif,image/jpeg,image/png"),(0,i.Z)(this,"onSelectFile",(e=>{const t=e.target.files&&e.target.files[0];if(!t)return;if(!/^image\//.test(t.type))return void(0,r.Iw)((0,d.t)("That is not a supported file type."));this.revokeObjectUrl();const{updateDataUrlState:a}=this.props,i=window.URL.createObjectURL(t);this.setState({file:t,objectURL:i},(()=>a({savedDataUrl:null})))})),(0,i.Z)(this,"revokeObjectUrl",(()=>this.state.objectURL&&window.URL.revokeObjectURL(this.state.objectURL))),(0,i.Z)(this,"onImageLoad",(()=>{const e=this.validateImage();if(e)return this.revokeObjectUrl(),this.setState({objectURL:null}),void(0,r.Iw)(e);const t=this.image.current;if(!t)return;const a={resizeDimensions:{size:Math.min(t.clientHeight,t.clientWidth),top:0,left:0}};this.setState(a,this.drawToCanvas)})),(0,i.Z)(this,"updateDimensions",(e=>{const t=this.cropContainer.current;if(!t)return;const{mousePosition:a,resizeDimensions:i}=this.state;let s=e.pageY,o=e.pageX,r=i.top+(s-a.pageY),n=i.left+(o-a.pageX);r<0?(r=0,s=a.pageY):r+i.size>t.clientHeight&&(r=t.clientHeight-i.size,s=a.pageY),n<0?(n=0,o=a.pageX):n+i.size>t.clientWidth&&(n=t.clientWidth-i.size,o=a.pageX),this.setState((e=>({resizeDimensions:{...e.resizeDimensions,top:r,left:n},mousePosition:{pageX:o,pageY:s}})))})),(0,i.Z)(this,"onMouseDown",(e=>{e.preventDefault(),this.setState({mousePosition:{pageY:e.pageY,pageX:e.pageX}}),document.addEventListener("mousemove",this.updateDimensions),document.addEventListener("mouseup",this.onMouseUp)})),(0,i.Z)(this,"onMouseUp",(e=>{e.preventDefault(),document.removeEventListener("mousemove",this.updateDimensions),document.removeEventListener("mouseup",this.onMouseUp),this.drawToCanvas()})),(0,i.Z)(this,"startResize",((e,t)=>{t.stopPropagation(),t.preventDefault(),document.addEventListener("mousemove",this.updateSize),document.addEventListener("mouseup",this.stopResize),this.setState({resizeDirection:e,mousePosition:{pageY:t.pageY,pageX:t.pageX}})})),(0,i.Z)(this,"stopResize",(e=>{e.stopPropagation(),e.preventDefault(),document.removeEventListener("mousemove",this.updateSize),document.removeEventListener("mouseup",this.stopResize),this.setState({resizeDirection:null}),this.drawToCanvas()})),(0,i.Z)(this,"updateSize",(e=>{const t=this.cropContainer.current;if(!t)return;const{mousePosition:a}=this.state,i=e.pageY-a.pageY,s=e.pageX-a.pageX;this.setState({resizeDimensions:this.getNewDimensions(t,i,s),mousePosition:{pageX:e.pageX,pageY:e.pageY}})})),(0,i.Z)(this,"getDiffNW",c),(0,i.Z)(this,"getDiffNE",u),(0,i.Z)(this,"getDiffSW",m),(0,i.Z)(this,"getDiffSE",g),(0,i.Z)(this,"getNewDimensions",((e,t,a)=>{const{resizeDimensions:i,resizeDirection:s}=this.state,o=this["getDiff"+s.toUpperCase()](t,a);let r=e.clientHeight-i.top,n=e.clientWidth-i.left;const l="nw"===s||"ne"===s,p="nw"===s||"sw"===s,d={top:0,left:0,size:i.size+o};l&&(d.top=i.top-o,r=e.clientHeight-d.top),p&&(d.left=i.left-o,n=e.clientWidth-d.left),d.top<0&&(d.size=d.size+d.top,p&&(d.left=d.left-d.top),d.top=0),d.left<0&&(d.size=d.size+d.left,l&&(d.top=d.top-d.left),d.left=0);const h=Math.min(n,r);return d.size>h?(l&&(d.top=d.top+d.size-h),p&&(d.left=d.left+d.size-h),d.size=h):d.size<this.MIN_DIMENSION&&(l&&(d.top=d.top+d.size-this.MIN_DIMENSION),p&&(d.left=d.left+d.size-this.MIN_DIMENSION),d.size=this.MIN_DIMENSION),{...i,...d}})),(0,i.Z)(this,"uploadClick",(e=>{e.preventDefault(),this.file.current&&this.file.current.click()}))}componentWillUnmount(){this.revokeObjectUrl()}validateImage(){const e=this.image.current;return e?e.naturalWidth<this.MIN_DIMENSION||e.naturalHeight<this.MIN_DIMENSION?(0,d._N)("Please upload an image larger than [size]px by [size]px.",{size:this.MIN_DIMENSION-1}):e.naturalWidth>this.MAX_DIMENSION||e.naturalHeight>this.MAX_DIMENSION?(0,d._N)("Please upload an image smaller than [size]px by [size]px.",{size:this.MAX_DIMENSION}):null:null}drawToCanvas(){const e=this.canvas.current;if(!e)return;const t=this.image.current;if(!t)return;const{left:a,top:i,size:s}=this.state.resizeDimensions,o=(t.naturalHeight/t.clientHeight+t.naturalWidth/t.clientWidth)/2;e.width=s*o,e.height=s*o,e.getContext("2d").drawImage(t,a*o,i*o,s*o,s*o,0,0,s*o,s*o),this.props.updateDataUrlState({dataUrl:e.toDataURL()})}get imageSrc(){var e;const{savedDataUrl:t,model:a,type:i}=this.props,s=null===(e=a.avatar)||void 0===e?void 0:e.avatarUuid,o=s&&`/${p.f6[i]||"avatar"}/${s}/`;return t||this.state.objectURL||o}renderImageCrop(){const e=this.imageSrc;if(!e)return null;const{resizeDimensions:t,resizeDirection:a}=this.state,i={top:t.top,left:t.left,width:t.size,height:t.size};return(0,h.tZ)(b,{resizeDirection:a,children:(0,h.BX)(D,{ref:this.cropContainer,children:[(0,h.tZ)("img",{ref:this.image,src:e,onLoad:this.onImageLoad,onDragStart:e=>e.preventDefault()}),(0,h.tZ)(S,{style:i,onMouseDown:this.onMouseDown,children:Object.keys(v).map((e=>(0,h.tZ)(z,{position:e,onMouseDown:this.startResize.bind(this,e)},e)))})]})})}render(){const e=this.imageSrc,t=(0,h.tZ)("a",{onClick:this.uploadClick}),a=(0,h.tZ)(l,{hasImage:!0,centered:!0,children:(0,h.tZ)("p",{children:(0,d._N)("[upload:Upload an image] to get started.",{upload:t})})});return(0,h.BX)(o.Fragment,{children:[!e&&a,e&&(0,h.tZ)(x,{ref:this.canvas}),this.renderImageCrop(),(0,h.BX)("div",{className:"form-group",children:[e&&(0,h.tZ)("a",{onClick:this.uploadClick,children:(0,d.t)("Change Photo")}),(0,h.tZ)(Z,{ref:this.file,type:"file",accept:this.ALLOWED_MIMETYPES,onChange:this.onSelectFile})]})]})}}f.displayName="AvatarCropper";const Z=(0,s.Z)("input",{target:"e12i7tw55"})({name:"1trwphv",styles:"position:absolute;opacity:0"}),b=(0,s.Z)("div",{target:"e12i7tw54"})("cursor:",(e=>e.resizeDirection?`${e.resizeDirection}-resize`:"default"),";text-align:center;margin-bottom:20px;background-size:20px 20px;background-position:0 0,0 10px,10px -10px,-10px 0px;background-color:",(e=>e.theme.background),";background-image:linear-gradient(\n      45deg,\n      ",(e=>e.theme.backgroundSecondary)," 25%,\n      rgba(0, 0, 0, 0) 25%\n    ),linear-gradient(-45deg, ",(e=>e.theme.backgroundSecondary)," 25%, rgba(0, 0, 0, 0) 25%),linear-gradient(45deg, rgba(0, 0, 0, 0) 75%, ",(e=>e.theme.backgroundSecondary)," 75%),linear-gradient(-45deg, rgba(0, 0, 0, 0) 75%, ",(e=>e.theme.backgroundSecondary)," 75%);"),D=(0,s.Z)("div",{target:"e12i7tw53"})({name:"nycxdm",styles:"display:inline-block;position:relative;max-width:100%"}),S=(0,s.Z)("div",{target:"e12i7tw52"})("position:absolute;border:2px dashed ",(e=>e.theme.gray300),";"),z=(0,s.Z)("div",{target:"e12i7tw51"})("border-radius:5px;width:10px;height:10px;position:absolute;background-color:",(e=>e.theme.gray300),";cursor:",(e=>`${e.position}-resize`),";",(e=>v[e.position].map((e=>`${e}: -5px;`))),";"),x=(0,s.Z)("canvas",{target:"e12i7tw50"})({name:"eivff4",styles:"display:none"});var w=a("./app/components/button.tsx"),y=a("./app/components/forms/controls/radioGroup.tsx"),I=a("./app/components/links/externalLink.tsx"),N=a("./app/components/loadingError.tsx"),U=a("./app/components/loadingIndicator.tsx"),M=a("./app/components/panels/index.tsx"),C=a("./app/styles/space.tsx"),E=a("./app/utils/withApi.tsx");class _ extends o.Component{constructor(){super(...arguments),(0,i.Z)(this,"state",{model:this.props.model,savedDataUrl:null,dataUrl:null,hasError:!1}),(0,i.Z)(this,"handleSaveSettings",(e=>{var t;const{endpoint:a,api:i,type:s}=this.props,{model:o,dataUrl:r}=this.state;e.preventDefault();const n=null==o||null===(t=o.avatar)||void 0===t?void 0:t.avatarType,l=null==r?void 0:r.split(",")[1],p={avatar_type:n};"upload"===n&&(p.avatar_photo=l),null!=s&&s.startsWith("sentryApp")&&(p.color="sentryAppColor"===s),i.request(a,{method:"PUT",data:p,success:e=>{this.setState({savedDataUrl:this.state.dataUrl}),this.handleSuccess(this.getModelFromResponse(e))},error:e=>{var t;const a=(null==e||null===(t=e.responseJSON)||void 0===t?void 0:t.avatar_photo)||[];a.length?a.map(this.handleError):this.handleError.bind(this,(0,d.t)("There was an error saving your preferences."))}})})),(0,i.Z)(this,"handleChange",(e=>{var t,a;return this.updateState({...this.state.model,avatar:{avatarUuid:null!==(t=null===(a=this.state.model.avatar)||void 0===a?void 0:a.avatarUuid)&&void 0!==t?t:"",avatarType:e}})}))}UNSAFE_componentWillReceiveProps(e){void 0!==e.model&&this.setState({model:e.model})}updateState(e){this.setState({model:e})}getModelFromResponse(e){var t,a;const{type:i}=this.props;if(!(null==i?void 0:i.startsWith("sentryApp")))return e;const s="sentryAppColor"===i;return{avatar:null!==(t=null==e||null===(a=e.avatars)||void 0===a?void 0:a.find((e=>{let{color:t}=e;return t===s})))&&void 0!==t?t:void 0}}handleError(e){(0,r.Iw)(e)}handleSuccess(e){const{onSave:t}=this.props;this.setState({model:e}),t(e),(0,r.S9)((0,d.t)("Successfully saved avatar preferences"))}render(){var e,t;const{allowGravatar:a,allowUpload:i,allowLetter:s,savedDataUrl:o,type:r,isUser:p,disabled:c,title:u,help:m,defaultChoice:g}=this.props,{hasError:v,model:Z}=this.state;if(v)return(0,h.tZ)(N.Z,{});if(!Z)return(0,h.tZ)(U.Z,{});const{allowDefault:b,preview:D,choiceText:S}=g||{},z=null!==(e=null===(t=Z.avatar)||void 0===t?void 0:t.avatarType)&&void 0!==e?e:"letter_avatar",x="letter_avatar"===z,C=Boolean(D&&"default"===z),E="team"===r,_="organization"===r,O=null==r?void 0:r.startsWith("sentryApp"),A=[];return b&&D&&A.push(["default",null!=S?S:(0,d.t)("Use default avatar")]),s&&A.push(["letter_avatar",(0,d.t)("Use initials")]),i&&A.push(["upload",(0,d.t)("Upload an image")]),a&&A.push(["gravatar",(0,d.t)("Use Gravatar")]),(0,h.BX)(M.s_,{children:[(0,h.tZ)(M.V9,{children:u||(0,d.t)("Avatar")}),(0,h.tZ)(M.N,{children:(0,h.BX)(X,{children:[(0,h.BX)(L,{inline:x||C,children:[(0,h.tZ)(y.Z,{style:{flex:1},choices:A,value:z,label:(0,d.t)("Avatar Type"),onChange:this.handleChange,disabled:c}),x&&(0,h.tZ)(n.Z,{gravatar:!1,style:{width:90,height:90},user:p?Z:void 0,organization:_?Z:void 0,team:E?Z:void 0,sentryApp:O?Z:void 0}),C&&D]}),(0,h.BX)(R,{children:[a&&"gravatar"===z&&(0,h.BX)(l,{children:[(0,d.t)("Gravatars are managed through "),(0,h.tZ)(I.Z,{href:"http://gravatar.com",children:"Gravatar.com"})]}),Z.avatar&&"upload"===z&&(0,h.tZ)(f,{...this.props,type:r,model:Z,savedDataUrl:o,updateDataUrlState:e=>this.setState(e)}),(0,h.BX)(j,{className:"form-actions",children:[m&&(0,h.tZ)(k,{children:m}),(0,h.tZ)(w.ZP,{type:"button",priority:"primary",onClick:this.handleSaveSettings,disabled:c,children:(0,d.t)("Save Avatar")})]})]})]})})]})}}_.displayName="AvatarChooser",(0,i.Z)(_,"defaultProps",{allowGravatar:!0,allowLetter:!0,allowUpload:!0,type:"user",onSave:()=>{},defaultChoice:{allowDefault:!1}});const k=(0,s.Z)("p",{target:"ecp1fla4"})("margin-right:auto;color:",(e=>e.theme.gray300),";font-size:14px;width:50%;"),L=(0,s.Z)("div",{target:"ecp1fla3"})("display:flex;flex-direction:",(e=>e.inline?"row":"column"),";"),X=(0,s.Z)("div",{target:"ecp1fla2"})("line-height:",(0,C.Z)(3),";padding:",(0,C.Z)(1.5)," ",(0,C.Z)(2),";margin:",(0,C.Z)(1.5)," ",(0,C.Z)(1)," ",(0,C.Z)(.5),";"),j=(0,s.Z)("fieldset",{target:"ecp1fla1"})("display:flex;align-items:center;margin-top:",(0,C.Z)(4),";padding-top:",(0,C.Z)(1.5),";"),R=(0,s.Z)("div",{target:"ecp1fla0"})("margin-top:",(0,C.Z)(1.5),";"),O=(0,E.Z)(_)}}]);
//# sourceMappingURL=../sourcemaps/app_components_avatarChooser_tsx.a6abd2be52cd632ad9cbedf60ed39b60.js.map