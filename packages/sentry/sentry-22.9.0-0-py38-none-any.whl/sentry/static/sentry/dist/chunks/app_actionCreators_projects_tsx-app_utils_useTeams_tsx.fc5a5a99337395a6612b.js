"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([["app_actionCreators_projects_tsx-app_utils_useTeams_tsx"],{"./app/actionCreators/projects.tsx":(e,t,s)=>{s.d(t,{$L:()=>I,$P:()=>g,M9:()=>Z,Nh:()=>m,Oe:()=>v,TA:()=>y,Vx:()=>d,bL:()=>j,iC:()=>$,mf:()=>E,pK:()=>f,rR:()=>S,xV:()=>x}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/core-js/modules/es.array.includes.js");var r=s("../node_modules/lodash/chunk.js"),o=s.n(r),a=s("../node_modules/lodash/debounce.js"),n=s.n(a),i=s("./app/actionCreators/indicator.tsx"),u=s("./app/actions/projectActions.tsx"),c=s("./app/locale.tsx"),l=s("./app/stores/projectsStatsStore.tsx");function d(e,t){u.Z.update(t.projectId,t.data);const s=`/projects/${t.orgId}/${t.projectId}/`;return e.requestPromise(s,{method:"PUT",data:t.data}).then((e=>(u.Z.updateSuccess(e),e)),(e=>{throw u.Z.updateError(e,t.projectId),e}))}function m(e,t){u.Z.loadStats(t.orgId,t.data);const s=`/organizations/${t.orgId}/stats/`;e.request(s,{query:t.query,success:e=>{u.Z.loadStatsSuccess(e)},error:e=>{u.Z.loadStatsError(e)}})}const h=new Set,p=n()(((e,t,s)=>{const r=l.Z.getAll(),a=Object.values(r).map((e=>{let{id:t}=e;return t})),n=Array.from(t).filter((e=>!a.includes(e)));if(!n.length)return void h.clear();const d=o()(n,10).map((t=>((e,t,s,r)=>{const o=`/organizations/${s}/projects/`,a={statsPeriod:"24h",query:t.map((e=>`id:${e}`)).join(" "),...r};return e.requestPromise(o,{query:a})})(e,t,s.orgId,s.query)));Promise.all(d).then((e=>{u.Z.loadStatsForProjectSuccess(e.reduce(((e,t)=>e.concat(t)),[]))})).catch((()=>{(0,i.Iw)((0,c.t)("Unable to fetch all project stats"))})),h.clear()}),50);function g(e,t,s){h.add(t),p(e,h,s)}function f(e){u.Z.setActive(e)}function S(e,t,s){const r=`/projects/${t}/${s.slug}/`;return u.Z.removeProject(s),e.requestPromise(r,{method:"DELETE"}).then((()=>{u.Z.removeProjectSuccess(s),(0,i.S9)((0,c._N)("[project] was successfully removed",{project:s.slug}))}),(e=>{throw u.Z.removeProjectError(s),(0,i.Iw)((0,c._N)("Error removing [project]",{project:s.slug})),e}))}function j(e,t,s,r){const o=`/projects/${t}/${s.slug}/transfer/`;return e.requestPromise(o,{method:"POST",data:{email:r}}).then((()=>{(0,i.S9)((0,c._N)("A request was sent to move [project] to a different organization",{project:s.slug}))}),(e=>{let t="";var r;throw e.status>=400&&e.status<500&&e.responseJSON&&(t=null===(r=e.responseJSON)||void 0===r?void 0:r.detail),t?(0,i.Iw)((0,c._N)("Error transferring [project]. [message]",{project:s.slug,message:t})):(0,i.Iw)((0,c._N)("Error transferring [project]",{project:s.slug})),e}))}function v(e,t,s,r){const o=`/projects/${t}/${s}/teams/${r.slug}/`;return(0,i.E3)(),u.Z.addTeam(r),e.requestPromise(o,{method:"POST"}).then((e=>{(0,i.S9)((0,c._N)("[team] has been added to the [project] project",{team:`#${r.slug}`,project:s})),u.Z.addTeamSuccess(r,s),u.Z.updateSuccess(e)}),(e=>{throw(0,i.Iw)((0,c._N)("Unable to add [team] to the [project] project",{team:`#${r.slug}`,project:s})),u.Z.addTeamError(),e}))}function Z(e,t,s,r){const o=`/projects/${t}/${s}/teams/${r}/`;return(0,i.E3)(),u.Z.removeTeam(r),e.requestPromise(o,{method:"DELETE"}).then((e=>{(0,i.S9)((0,c._N)("[team] has been removed from the [project] project",{team:`#${r}`,project:s})),u.Z.removeTeamSuccess(r,s),u.Z.updateSuccess(e)}),(e=>{throw(0,i.Iw)((0,c._N)("Unable to remove [team] from the [project] project",{team:`#${r}`,project:s})),u.Z.removeTeamError(e),e}))}function y(e,t){u.Z.changeSlug(e,t)}function I(e,t,s,r,o){let a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:{};return e.requestPromise(`/teams/${t}/${s}/projects/`,{method:"POST",data:{name:r,platform:o,default_rules:a.defaultRules}})}function $(e,t,s,r){return e.requestPromise(`/projects/${t}/${s}/docs/${r}/`)}function x(e,t){return e.requestPromise(`/organizations/${t}/projects-count/`)}async function E(e,t,s){return(await e.requestPromise(`/organizations/${t}/releases/stats/`,{method:"GET",query:{statsPeriod:"90d",project:s,per_page:1}})).length>0}},"./app/actionCreators/teams.tsx":(e,t,s)=>{s.d(t,{Cm:()=>h,PX:()=>c,s:()=>m,tT:()=>p,um:()=>d,z_:()=>l}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("./app/actionCreators/indicator.tsx"),o=s("./app/actions/teamActions.tsx"),a=s("./app/locale.tsx"),n=s("./app/utils/callIfFunction.tsx");if("app"==s.j)var i=s("./app/utils/guid.tsx");const u=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0;for(var s=arguments.length,r=new Array(s>2?s-2:0),o=2;o<s;o++)r[o-2]=arguments[o];(0,n.g)(e[t],...r)};async function c(e,t){const s=await e.requestPromise(`/organizations/${t.orgId}/user-teams/`);o.Z.loadUserTeams(s)}function l(e,t){o.Z.updateSuccess(e,t)}function d(e,t,s){var r;const a=`/organizations/${t.orgId}/members/${null!==(r=t.memberId)&&void 0!==r?r:"me"}/teams/${t.teamId}/`,n=(0,i.E)();return o.Z.update(n,t.teamId),e.request(a,{method:"POST",success:e=>{o.Z.updateSuccess(t.teamId,e),u(s,"success",e)},error:e=>{o.Z.updateError(n,t.teamId,e),u(s,"error",e)}})}function m(e,t,s){const r=`/organizations/${t.orgId}/members/${t.memberId||"me"}/teams/${t.teamId}/`,a=(0,i.E)();return o.Z.update(a,t.teamId),e.request(r,{method:"DELETE",success:e=>{o.Z.updateSuccess(t.teamId,e),u(s,"success",e)},error:e=>{o.Z.updateError(a,t.teamId,e),u(s,"error",e)}})}function h(e,t,s){return o.Z.createTeam(t),e.requestPromise(`/organizations/${s.orgId}/teams/`,{method:"POST",data:t}).then((e=>(o.Z.createTeamSuccess(e),(0,r.S9)((0,a._N)("[team] has been added to the [organization] organization",{team:`#${e.slug}`,organization:s.orgId})),e)),(e=>{throw o.Z.createTeamError(t.slug,e),(0,r.Iw)((0,a._N)("Unable to create [team] in the [organization] organization",{team:`#${t.slug}`,organization:s.orgId})),e}))}function p(e,t){return o.Z.removeTeam(t.teamId),e.requestPromise(`/teams/${t.orgId}/${t.teamId}/`,{method:"DELETE"}).then((e=>(o.Z.removeTeamSuccess(t.teamId,e),(0,r.S9)((0,a._N)("[team] has been removed from the [organization] organization",{team:`#${t.teamId}`,organization:t.orgId})),e)),(e=>{throw o.Z.removeTeamError(t.teamId,e),(0,r.Iw)((0,a._N)("Unable to remove [team] from the [organization] organization",{team:`#${t.teamId}`,organization:t.orgId})),e}))}},"./app/stores/projectsStatsStore.tsx":(e,t,s)=>{s.d(t,{Z:()=>i}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js");var r=s("../node_modules/reflux/src/index.js"),o=s("./app/actions/projectActions.tsx"),a=s("./app/utils/makeSafeRefluxStore.ts");const n={itemsBySlug:{},unsubscribeListeners:[],init(){this.reset(),this.unsubscribeListeners.push(this.listenTo(o.Z.loadStatsForProjectSuccess,this.onStatsLoadSuccess)),this.unsubscribeListeners.push(this.listenTo(o.Z.update,this.onUpdate)),this.unsubscribeListeners.push(this.listenTo(o.Z.updateError,this.onUpdateError))},getInitialState(){return this.itemsBySlug},reset(){this.itemsBySlug={},this.updatingItems=new Map},onStatsLoadSuccess(e){e.forEach((e=>{this.itemsBySlug[e.slug]=e})),this.trigger(this.itemsBySlug)},onUpdate(e,t){const s=this.getBySlug(e);if(this.updatingItems.set(e,s),!s)return;const r={...s,...t};this.itemsBySlug={...this.itemsBySlug,[s.slug]:r},this.trigger(this.itemsBySlug)},onUpdateSuccess(e){this.updatingItems.delete(e.slug)},onUpdateError(e,t){const s=this.updatingItems.get(t);s&&(this.updatingItems.delete(t),this.itemsBySlug={...this.itemsBySlug,[s.slug]:{...s}},this.trigger(this.itemsBySlug))},getAll(){return this.itemsBySlug},getBySlug(e){return this.itemsBySlug[e]}},i=(0,r.createStore)((0,a.Y)(n))},"./app/utils/isActiveSuperuser.tsx":(e,t,s)=>{s.d(t,{M:()=>a});var r=s("../node_modules/js-cookie/dist/js.cookie.mjs"),o=s("./app/stores/configStore.tsx");function a(){const{isSuperuser:e}=o.Z.get("user")||{};return!(!e||(r.Z.set("su","test"),void 0!==r.Z.get("su")))}},"./app/utils/useTeams.tsx":(e,t,s)=>{s.d(t,{Z:()=>g}),s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/core-js/modules/es.array.includes.js");var r=s("../node_modules/react/index.js"),o=s("../node_modules/lodash/uniqBy.js"),a=s.n(o),n=s("./app/actionCreators/teams.tsx"),i=s("./app/actions/teamActions.tsx"),u=s("./app/stores/organizationStore.tsx"),c=s("./app/stores/teamStore.tsx"),l=s("./app/stores/useLegacyStore.tsx"),d=s("./app/utils/isActiveSuperuser.tsx"),m=s("./app/utils/parseLinkHeader.tsx"),h=s("./app/utils/useApi.tsx");async function p(e,t){let{slugs:s,ids:r,search:o,limit:a,lastSearch:n,cursor:i}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const u={};var c;void 0!==s&&s.length>0&&(u.query=s.map((e=>`slug:${e}`)).join(" ")),void 0!==r&&r.length>0&&(u.query=r.map((e=>`id:${e}`)).join(" ")),o&&(u.query=`${null!==(c=u.query)&&void 0!==c?c:""} ${o}`.trim());const l=n===o||!n&&!o;l&&i&&(u.cursor=i),void 0!==a&&(u.per_page=a);let d=!1,h=null;const[p,,g]=await e.requestPromise(`/organizations/${t}/teams/`,{includeAllArgs:!0,query:u}),f=null==g?void 0:g.getResponseHeader("Link");if(f){var S,j;const e=(0,m.Z)(f);d=null==e||null===(S=e.next)||void 0===S?void 0:S.results,h=null==e||null===(j=e.next)||void 0===j?void 0:j.cursor}return{results:p,hasMore:d,nextCursor:h}}const g=function(){var e,t,s;let{limit:o,slugs:m,ids:g,provideUserTeams:f}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const S=(0,h.Z)(),{organization:j}=(0,l.X)(u.Z),v=(0,l.X)(c.Z),Z=null==j?void 0:j.slug,y=new Set(v.teams.map((e=>e.slug))),I=null!==(e=null==m?void 0:m.filter((e=>!y.has(e))))&&void 0!==e?e:[],$=new Set(v.teams.map((e=>e.id))),x=null!==(t=null==g?void 0:g.filter((e=>!$.has(e))))&&void 0!==t?t:[],E=I.length>0,T=x.length>0,w=f&&!v.loadedUserTeams,_=!E&&!w&&!T,[b,P]=(0,r.useState)({initiallyLoaded:_,fetching:!1,hasMore:v.hasMore,lastSearch:null,nextCursor:v.cursor,fetchError:null}),q=(0,r.useRef)(null);if(void 0!==m||void 0!==g){var z;const e=null!==(z=m||g)&&void 0!==z?z:[];null===q.current&&(q.current=new Set(e)),(e.length!==q.current.size||e.some((e=>{var t;return!(null!==(t=q.current)&&void 0!==t&&t.has(e))})))&&(q.current=new Set(e))}async function L(){if(void 0!==Z){P({...b,fetching:!0});try{await(0,n.PX)(S,{orgId:Z}),P({...b,fetching:!1,initiallyLoaded:!0})}catch(e){console.error(e),P({...b,fetching:!1,initiallyLoaded:!0,fetchError:e})}}}async function M(){if(void 0!==Z){P({...b,fetching:!0});try{const{results:e,hasMore:t,nextCursor:s}=await p(S,Z,{slugs:I,ids:x,limit:o}),r=a()([...e,...v.teams],(e=>{let{id:t}=e;return t}));i.Z.loadTeams(r),P({...b,hasMore:t,fetching:!1,initiallyLoaded:!0,nextCursor:s})}catch(e){console.error(e),P({...b,fetching:!1,initiallyLoaded:!0,fetchError:e})}}}function C(e){return""!==e?A(e):(b.hasMore===v.hasMore&&b.nextCursor===v.cursor||P({...b,lastSearch:e,hasMore:v.hasMore,nextCursor:v.cursor}),Promise.resolve())}async function A(e){const{lastSearch:t}=b,s=e?b.nextCursor:v.cursor;if(void 0!==Z){P({...b,fetching:!0});try{S.clear();const{results:r,hasMore:n,nextCursor:u}=await p(S,Z,{search:e,limit:o,lastSearch:t,cursor:s}),c=a()([...v.teams,...r],(e=>{let{slug:t}=e;return t}));e?c.length>v.teams.length&&i.Z.loadTeams(c):i.Z.loadTeams(c,n,u),P({...b,hasMore:n&&v.hasMore,fetching:!1,lastSearch:null!=e?e:null,nextCursor:u})}catch(e){console.error(e),P({...b,fetching:!1,fetchError:e})}}else console.error("Cannot fetch teams without an organization in context")}(0,r.useEffect)((()=>{E||T?M():w&&L()}),[q.current,f]);const B=(0,d.M)(),N=(0,r.useMemo)((()=>m?v.teams.filter((e=>m.includes(e.slug))):g?v.teams.filter((e=>g.includes(e.id))):f&&!B?v.teams.filter((e=>e.isMember)):v.teams),[v.teams,g,m,f,B]),U={teams:N,fetching:b.fetching||v.loading,initiallyLoaded:b.initiallyLoaded,fetchError:b.fetchError,hasMore:null!==(s=b.hasMore)&&void 0!==s?s:v.hasMore,onSearch:C,loadMore:A};return U}}}]);
//# sourceMappingURL=../sourcemaps/app_actionCreators_projects_tsx-app_utils_useTeams_tsx.8ceaa58d463c4217a675760b4e62e145.js.map